---
title: "Input-demand-analysis"
author: "jafshin"
date: "13/05/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(readr)
library(ggplot2)
library(viridis)
library(sf)
library(readxl)

library(ggspatial)

```

## Reading inputs

Here I am comparing Origin and Destinations to Census Journey to work

```{r cars}

outputDir <- "~/github/matsim-melbourne/demand/output-v1.1-10pct/"
plans <- read_csv(paste0(outputDir,"7.time/plan.csv"))
attribs <- rbind(read_csv(paste0(outputDir,"3.match/match_1.csv")),
                 read_csv(paste0(outputDir,"3.match/match_2.csv")),
                 read_csv(paste0(outputDir,"3.match/match_3.csv")),
                 read_csv(paste0(outputDir,"3.match/match_4.csv")),
                 read_csv(paste0(outputDir,"3.match/match_5.csv")))

plansWithAttrib <- plans %>% 
  left_join(attribs, by = "AgentId")

glimpse(plansWithAttrib)

```

## Activity location map

SA2

```{r}

actLocationsSA2 <- plans %>% 
  distinct(x,y,LocationType, .keep_all = T) %>% 
  mutate(SA1_MAINCODE_2016=as.character(SA1_MAINCODE_2016)) %>% 
  left_join(st_drop_geometry(boundaries[,c("SA1_MAIN16","SA2_NAME16")]), by = c("SA1_MAINCODE_2016"="SA1_MAIN16")) %>% 
  group_by(SA2_NAME16, LocationType) %>% 
  summarise(n=n()) %>% 
  ungroup() %>% 
  mutate(n=ifelse(is.na(n), 0, n)) %>% 
  filter(!is.na(LocationType)) 
  
SA2sMap <- boundaries %>%  filter(SA2_NAME16%in%actLocationsSA2$SA2_NAME16) %>% 
  group_by(SA2_NAME16) %>% 
  summarise(geometry=st_union(geometry)) 

homeLocationsSA2 <- actLocationsSA2 %>% 
  filter(LocationType=="home") %>% 
  left_join(SA2sMap, by = "SA2_NAME16") %>% 
  st_as_sf()

homeLocationsSA2 %>% 
  st_centroid() %>% 
  mutate(n_cut = cut_interval(n, n = 5)) %>% 
  ggplot() +
  annotation_map_tile(type="osmgrayscale",zoom=9, alpha=0.6)+
  geom_sf(aes(size=n, colour=n )) +
  scale_radius(name="# home destinations",  range = c(0.1,4))  +
  scale_color_viridis_c(name="# home destinations", trans = "sqrt", alpha = .6, 
                        option = "magma") 

ggsave("~/Dropbox/Apps/Overleaf/MATSimMelbournePaper/figs/homeLocationsSA2.png")
write_sf(homeLocationsSA2, "actLocationsSA2.sqlite", layer="Home",delete_layer = T)

workLocationsSA2 <- actLocationsSA2 %>% 
  filter(LocationType=="work") %>% 
  left_join(SA2sMap, by = "SA2_NAME16") %>% 
  st_as_sf()

workLocationsSA2 %>%
  st_centroid() %>%
  mutate(n_cut = cut_interval(n, n = 5)) %>%
  ggplot() +
  annotation_map_tile(type="osmgrayscale",zoom=9, alpha=0.6)+
  geom_sf(aes(size=n_cut, colour=n_cut )) #+
  # scale_color_viridis_c(name="# work destinations", trans = "sqrt", alpha = .6,
  #                       option = "magma") +
  # scale_radius(name="# work destinations", range = c(0.5,6))

mybreaks <- c(20, 40, 80, 100)
library(viridis)

workLocationsSA2 %>%
  st_centroid() %>%
  # mutate(n_cut = cut_interval(n, n = 5)) %>%
  ggplot() +
  annotation_map_tile(type="osmgrayscale",zoom=9, alpha=0.6)+
  geom_sf(aes( size=n, colour=n, alpha=n ))  +
  scale_color_viridis(option="magma", trans="sqrt", breaks=mybreaks, name="Work destinations" ) +
  scale_alpha_continuous(name="Work destinations", trans="sqrt", range=c(0.1, .9), breaks=mybreaks) +
  scale_size_continuous(name="Work destinations", trans="sqrt",  range=c(0.3, 5), breaks=mybreaks) +
    theme_void() + 
    guides( colour = guide_legend()) +
    theme(
      legend.position = c(0.85, 0.85),
      text = element_text(color = "#22211d"),
      plot.background = element_rect(fill = "#f5f5f2", color = NA), 
      panel.background = element_rect(fill = "#f5f5f2", color = NA), 
      legend.background = element_rect(fill = "#f5f5f2", color = NA)
    )

ggsave("~/Dropbox/Apps/Overleaf/MATSimMelbournePaper/figs/workLocationsSA2.png")
write_sf(workLocationsSA2, "actLocationsSA2.sqlite", layer="Work",delete_layer = T)

```


SA3 Home location

```{r}

actLocationsSA3 <- plans %>% 
  distinct(x,y,LocationType, .keep_all = T) %>% 
  mutate(SA1_MAINCODE_2016=as.character(SA1_MAINCODE_2016)) %>% 
  left_join(st_drop_geometry(boundaries[,c("SA1_MAIN16","SA3_NAME16")]), by = c("SA1_MAINCODE_2016"="SA1_MAIN16")) %>% 
  group_by(SA3_NAME16, LocationType) %>% 
  summarise(n=n()) %>% 
  ungroup() %>% 
  mutate(n=ifelse(is.na(n), 0, n)) %>% 
  filter(!is.na(LocationType)) 
  
SA3sMap <- boundaries %>%  filter(SA3_NAME16%in%actLocationsSA3$SA3_NAME16) %>% 
  group_by(SA3_NAME16) %>% 
  summarise(geometry=st_union(geometry)) 

homeLocationsSA3 <- actLocationsSA3 %>% 
  filter(LocationType=="home") %>% 
  left_join(SA3sMap, by = "SA3_NAME16") %>% 
  st_as_sf()

# homeLocationsSA3 %>%
#   st_centroid() %>%
#   mutate(n_cut = cut_interval(n, n = 5)) %>%
#   ggplot() +
#   annotation_map_tile(type="osmgrayscale",zoom=9, alpha=0.6)+
#   geom_sf(aes(size=n, colour=n )) +
#   scale_radius(name="# home destinations",  range = c(0.1,4))  +
#   scale_color_viridis_c(name="# home destinations", trans = "sqrt", alpha = .6,
#                         option = "magma")

mybreaks1 <- c(1000, 2000, 3000, 4000, 5000)

homeLocationsSA3 %>%
  st_centroid() %>%
  # mutate(n_cut = cut_interval(n, n = 5)) %>%
  ggplot() +
  annotation_map_tile(type="osmgrayscale",zoom=9, alpha=0.6)+
  geom_sf(data = SA3sMap) +
  geom_sf(aes( size=n, colour=n ))  +
  scale_color_viridis(option="magma", trans="sqrt", breaks=mybreaks1, name="Home destinations" ) +
  scale_alpha_continuous(name="Home destinations", trans="sqrt", range=c(0.1, .9), breaks=mybreaks1) +
  scale_size_continuous(name="Home destinations", range=c(0.3, 8), breaks=mybreaks1) +
    theme_void() + 
    guides( colour = guide_legend()) +
    theme(
      legend.position = c(0.85, 0.85),
      text = element_text(color = "#22211d"),
      plot.background = element_rect(fill = "#f5f5f2", color = NA), 
      panel.background = element_rect(fill = "#f5f5f2", color = NA), 
      legend.background = element_rect(fill = "#f5f5f2", color = NA)
    )

ggsave("~/Dropbox/Apps/Overleaf/MATSimMelbournePaper/figs/homeLocationsSA3.png",
       width = 7, height = 7)
write_sf(homeLocationsSA3, "actLocationsSA3.sqlite", layer="Home",delete_layer = T)

```

SA3 work location

```{r}

workLocationsSA3 <- actLocationsSA3 %>% 
  filter(LocationType=="work") %>% 
  left_join(SA3sMap, by = "SA3_NAME16") %>% 
  st_as_sf()

# workLocationsSA3 %>%
#   st_centroid() %>%
#   mutate(n_cut = cut_interval(n, n = 5)) %>%
#   ggplot() +
#   annotation_map_tile(type="osmgrayscale",zoom=9, alpha=0.6)+
#   geom_sf(aes(size=n_cut, colour=n_cut )) #+
  # scale_color_viridis_c(name="# work destinations", trans = "sqrt", alpha = .6,
  #                       option = "magma") +
  # scale_radius(name="# work destinations", range = c(0.5,6))

mybreaks <- c(50, 100, 150, 200, 250, 300)

workLocationsSA3 %>%
  st_centroid() %>%
  # mutate(n_cut = cut_interval(n, n = 5)) %>%
  ggplot() +
  annotation_map_tile(type="osmgrayscale",zoom=9, alpha=0.6)+
  geom_sf(data = SA3sMap) +
  geom_sf(aes( size=n, colour=n ))  +
  scale_color_viridis(option="magma", trans="sqrt", breaks=mybreaks, name="Work destinations" ) +
  scale_alpha_continuous(name="Work destinations", trans="sqrt", range=c(0.1, .9), breaks=mybreaks) +
  scale_size_continuous(name="Work destinations", range=c(0.3, 8), breaks=mybreaks) +
    theme_void() + 
    guides( colour = guide_legend()) +
    theme(
      legend.position = c(0.85, 0.85),
      text = element_text(color = "#22211d"),
      plot.background = element_rect(fill = "#f5f5f2", color = NA), 
      panel.background = element_rect(fill = "#f5f5f2", color = NA), 
      legend.background = element_rect(fill = "#f5f5f2", color = NA)
    )

ggsave("~/Dropbox/Apps/Overleaf/MATSimMelbournePaper/figs/workLocationsSA3.png",
       width = 7, height = 7)
write_sf(workLocationsSA3, "actLocationsSA3.sqlite", layer="Work",delete_layer = T)

```


## Trips to work OD analysis

Selecting the work trips

```{r}
tripsToWork <- plansWithAttrib %>% 
  filter(lag(Activity=="Home") & Activity=="Work")%>% 
  distinct(AgentId, .keep_all=T)

glimpse(tripsToWork)
```

## OD analysis

Aggregating ODs at SA3

```{r}
boundaries <- read_sf("~/ownCloud/Data/ABS_Boundaries/1270055001_sa1_2016_aust_shape/SA1_2016_AUST.shp") %>% 
  st_transform(28355)
boundariesSA2 <- st_drop_geometry(boundaries[,c("SA2_MAIN16","SA3_NAME16")]) %>% 
  distinct()

agentHomes <- plansWithAttrib %>% 
  filter(Activity=="Home") %>% 
  mutate(HomeSA2=as.character(SA2_MAINCODE)) %>% 
  dplyr::select(AgentId, HomeSA2) %>% 
  distinct(AgentId, .keep_all=T)

tripsToWorkSA3 <- tripsToWork %>%       
  # mutate(GEOMETRY=paste0("POINT(",x," ",y,")")) %>%
  # st_as_sf(wkt = "GEOMETRY", crs = 28355) %>% 
  # st_join(boundaries)
  mutate(SA1_MAINCODE_2016.x=as.character(SA1_MAINCODE_2016.x)) %>% 
  left_join(st_drop_geometry(boundaries[,c("SA1_MAIN16","SA3_NAME16")]), by = c("SA1_MAINCODE_2016.x"="SA1_MAIN16")) %>% 
  rename("DestinationSA3"="SA3_NAME16") %>% 
  left_join(agentHomes, by="AgentId") %>% 
  left_join(boundariesSA2, by = c("HomeSA2"="SA2_MAIN16")) %>% 
  rename("HomeSA3"="SA3_NAME16")  %>% 
  group_by(HomeSA3,DestinationSA3)  %>% 
  summarise(numTrips=n()) %>% 
  mutate(DemandTripPerHomeSA3=10*numTrips) %>%
  mutate(DemandTripPctPerHomeSA3=100*numTrips/sum(numTrips)) %>%
  dplyr::select(-numTrips) %>% 
  ungroup()
  
ODPairs <- tripsToWorkSA3 %>% 
  transmute(pairs=paste0(HomeSA3,"_",DestinationSA3))

tripsToWorkSA3 %>% glimpse()
# tripsToWorkSA3 %>% filter(HomeSA3==DestinationSA3)
tripsToWorkSA3$DemandTripPerHomeSA3 %>% sum()
```


```{r}
censusOd <- read_csv("~/ownCloud/Data/ABS_Census/SA3 (UR) and SA3 (POW).csv", skip=9) %>% 
  rename(HomeSA3=`SA3 (UR)`, DestinationSA3=`SA3 (POW)`) %>% 
  dplyr::select(-Counting, -X5)  %>%
  filter(HomeSA3!="Total" & DestinationSA3!="Total") %>% 
  filter(paste0(HomeSA3,"_",DestinationSA3) %in% ODPairs$pairs) %>%  
  # filter(HomeSA3%in%tripsToWorkSA3$HomeSA3) %>% 
  # filter(DestinationSA3%in%tripsToWorkSA3$DestinationSA3) %>% 
  group_by(HomeSA3) %>% 
  # mutate(numTrips=sum(Count)) %>%
  mutate(CensusTripPctPerHomeSA3=100*Count/sum(Count)) %>%
  mutate(CensusTripPerHomeSA3=Count) %>%
  dplyr::select(-Count)

censusOd %>% glimpse()
censusOd$CensusTripPerHomeSA3 %>% sum()
```

Joining the two together

```{r}

ODPcts <- tripsToWorkSA3 %>% 
  left_join(censusOd, by = c("HomeSA3","DestinationSA3")) 

ODPcts %>% 
  ggplot(aes(x = CensusTripPctPerHomeSA3, y= DemandTripPctPerHomeSA3))+
  geom_point() + scale_x_continuous(trans='log2') +
  scale_y_continuous(trans='log2')

```

```{r}
ODError <- tripsToWorkSA3 %>% 
  left_join(censusOd, by = c("HomeSA3","DestinationSA3")) %>%  
  filter(CensusTripPerHomeSA3!=0) %>% # I need to look into this
  mutate(deltaSq=abs(DemandTripPctPerHomeSA3-CensusTripPctPerHomeSA3)/CensusTripPctPerHomeSA3) %>% 
  group_by(HomeSA3) %>%
  # summarise(n=n())
  summarise(n=n(),mae=(1/n)*(sum(deltaSq))) 


ODError$HomeSA3 <- factor(ODError$HomeSA3, levels = ODError$HomeSA3[order(ODError$mae)])
ODError %>% 
  arrange(desc(mae)) %>% 
  ggplot(aes(x=mae,y=HomeSA3, fill=mae)) +
  geom_col() +
  scale_fill_viridis_c()

```


```{r}
SA3sMap <- boundaries %>% filter(SA3_NAME16%in%tripsToWorkSA3$HomeSA3) %>% 
  group_by(SA3_NAME16) %>% 
  summarise(geometry=st_union(geometry)) 

SA3sMap %>% 
  left_join(ODError, by=c("SA3_NAME16"="HomeSA3")) %>% 
  ggplot() +
  annotation_map_tile(type="osmgrayscale",zoom=9) +
  geom_sf(aes(fill = mae)) +
  scale_fill_viridis_c(trans = "sqrt", alpha = .5, name= "MAE") 

ggsave("~/Dropbox/Apps/Overleaf/MATSimMelbournePaper/figs/od-mae.png")
```
