---
title: "road-traffic-comparison"
author: "jafshin"
date: "16/06/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(sf)

```

```{r folder structure}

simDesc <- "10pct_noMc_bicycle_v1"
outputDir <- paste0("./calibrationOutputs/", simDesc,"/")
if (!dir.exists(outputDir)) dir.create(outputDir)


```

## Road traffic comparison

This document is to compare traffic volumes from real-world observations to simulation outputs.

Steps before this step:
- Running **observation-preparation.Rmd** to process real-world observations and generate three 
- Runnning **simOutputProcessing.Rmd** to process to create traffic volume joined

## Car traffic

```{r Reading input car traffic data}

amCarObservations <- read_sf("./data/observationsJoined/carAmObsJoined2Network.sqlite") %>% 
  dplyr::select(link_id, starts_with("x")) 
pmCarObservations <- read_sf("./data/observationsJoined/carPmObsJoined2Network.sqlite") %>% 
  dplyr::select(link_id, starts_with("x"))

if (all(colnames(amCarObservations)==colnames(pmCarObservations))) {
  if (nrow(filter(amCarObservations,link_id%in%pmCarObservations$link_id))==0) {
      carObservations <- rbind(st_drop_geometry(amCarObservations), 
                               st_drop_geometry(pmCarObservations))
  }else print("There is a duplicate link_id in AM and PM data!")
}else print("Colnames in AM and PM car observations does not match!")

carSimulation <- read_sf("./data/simOutputJoined/networkLinksWithHourlyVol.sqlite", 
                         layer="car")

```


```{r restructuring observation and simulation car data}

carObservationsLong <- carObservations %>% 
  pivot_longer(cols = starts_with("x"), names_to="hour", values_to="obs_volume") %>% 
  mutate(hour=as.integer(str_remove(hour,"x"))) #%>% 
  # mutate(Source="Observation")

carSimulationFiltered <- carSimulation %>% 
  st_drop_geometry() %>% 
  dplyr::select(link_id=id, starts_with("X")) %>% 
  filter(link_id %in% carObservations$link_id)

carSimulationLong <- carSimulationFiltered %>% 
  pivot_longer(cols = starts_with("X"), names_to="hour", values_to="sim_volume") %>% 
  mutate(hour=as.integer(str_remove(hour,"X"))) %>% 
  mutate(sim_volume=sim_volume*10) # %>% # Because I used 10% sample
  # mutate(Source="Simulation")

carData <- carObservationsLong %>% 
  left_join(carSimulationLong, by = c("link_id","hour"))

```

Plotting the volumes

```{r}

carData %>% 
  # filter(link_id==11169) %>% 
  ggplot(aes(x=hour)) +
  geom_line(aes(y=obs_volume, color="observation")) + 
  geom_line(aes(y=sim_volume, color="simulation")) +
  facet_wrap("link_id")

ggsave(paste0(outputDir,"car.png"), width= 50, height = 50, units="cm")

```


Calculating GEH Statistic for car traffic

```{r}

carDataWithGEH <- carData %>% 
  mutate(gehStat= sqrt((2*(sim_volume-obs_volume)^2)/(sim_volume+obs_volume)))

st_write(carDataWithGEH, paste0(outputDir,"calibrationData.sqlite"), 
         layer="car", delete_layer=T)
```

Plotting the GEH for car traffic

```{r}

carDataWithGEH %>% 
  # filter(link_id==11169) %>% 
  ggplot(aes(x=hour)) +
  geom_line(aes(y=gehStat)) + 
  facet_wrap("link_id")

ggsave(paste0(outputDir,"carGeh.png"), width= 50, height = 50, units="cm")

```



## Bike traffic

```{r Reading input bike traffic data}

bikeObservations <- read_sf("./data/observationsJoined/cyclingObsJoined2Network.sqlite") %>% 
  dplyr::select(link_id, hour, obs_volume = count) %>% 
  st_drop_geometry()

bikeSimulation <- read_sf("./data/simOutputJoined/networkLinksWithHourlyVol.sqlite", 
                         layer="bike")

```


```{r restructuring observation and simulation bike data}

bikeSimulationFiltered <- bikeSimulation %>% 
  st_drop_geometry() %>% 
  dplyr::select(link_id=id, starts_with("X")) %>% 
  filter(link_id %in% bikeObservations$link_id)

bikeSimulationLong <- bikeSimulationFiltered %>% 
  pivot_longer(cols = starts_with("X"), names_to="hour", values_to="sim_volume") %>% 
  mutate(hour=as.integer(str_remove(hour,"X"))) %>% 
  mutate(sim_volume=sim_volume*10) # %>% # Because I used 10% sample
  # mutate(Source="Simulation")

bikeData <- bikeObservations %>% 
  left_join(bikeSimulationLong, by = c("link_id","hour"))

```

Plotting the volumes

```{r}

bikeData %>% 
  # filter(link_id==11169) %>% 
  ggplot(aes(x=hour)) +
  geom_line(aes(y=obs_volume, color="observation")) + 
  geom_line(aes(y=sim_volume, color="simulation")) +
  facet_wrap("link_id")

ggsave(paste0(outputDir,"bike.png"), width= 50, height = 50, units="cm")

```

Calculating GEH Statistic for Bike traffic

```{r}

bikeDataWithGEH <- bikeData %>% 
  mutate(gehStat= sqrt((2*(sim_volume-obs_volume)^2)/(sim_volume+obs_volume)))
st_write(bikeDataWithGEH, paste0(outputDir,"calibrationData.sqlite"), 
         layer="bike", delete_layer=T)
```

Plotting the GEH for Bike traffic

```{r}

bikeDataWithGEH %>% 
  # filter(link_id==11169) %>% 
  ggplot(aes(x=hour)) +
  geom_line(aes(y=gehStat)) + 
  facet_wrap("link_id")

ggsave(paste0(outputDir,"bikeGeh.png"), width= 50, height = 50, units="cm")

```


